version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: swim-backend
    volumes:
      - ./db.sqlite3:/app/db.sqlite3
      - ./logs:/app/logs
      - ./media:/app/media
      - ./static:/app/static
    env_file:
      - ./env/app.env
      - ./env/ldap.env
    environment:
      - DJANGO_SETTINGS_MODULE=swim_backend.settings
      - DEBUG=${DEBUG:-False}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}
      - SECRET_KEY=${SECRET_KEY:-change-this-in-production}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///db.sqlite3}
      # LDAP settings (optional - configure in .env.ldap)
      - LDAP_SERVER_URI=${LDAP_SERVER_URI:-}
      - LDAP_BIND_DN=${LDAP_BIND_DN:-}
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD:-}
      - LDAP_USER_SEARCH_BASE=${LDAP_USER_SEARCH_BASE:-}
      # Global Device Credentials
      - GLOBAL_DEVICE_USERNAME=${GLOBAL_DEVICE_USERNAME:-admin}
      - GLOBAL_DEVICE_PASSWORD=${GLOBAL_DEVICE_PASSWORD:-password}
      - GLOBAL_DEVICE_SECRET=${GLOBAL_DEVICE_SECRET:-}
      # File Server Settings
      - DEFAULT_FILE_SERVER=${DEFAULT_FILE_SERVER:-}
      - FILE_SERVER_BASE_PATH=${FILE_SERVER_BASE_PATH:-/}
    networks:
      - swim-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: swim-frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
      - "${FRONTEND_SSL_PORT:-443}:443"
    volumes:
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - swim-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  swim-network:
    driver: bridge

volumes:
  db-data:
  logs-data:
  media-data:
  static-data:
